<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Fireworks Generator</title>
    <style>
        /* Basic reset and full-screen setup */
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            color: #fff;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        canvas {
            display: block;
            background-color: #000;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* Overlay for starting audio */
        #audioOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            color: #fff;
            cursor: pointer;
            z-index: 10;
            text-align: center;
        }

        /* Controls styling */
        #controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            border-radius: 12px;
            padding: 10px;
            display: flex;
            gap: 10px;
            z-index: 5;
            flex-wrap: wrap;
            justify-content: center;
        }

        #controls button {
            background-color: #333;
            border: 2px solid #555;
            color: #fff;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s, border-color 0.2s;
        }

        #controls button:hover {
            background-color: #555;
        }

        #controls button.active {
            background-color: #007bff;
            border-color: #007bff;
            font-weight: bold;
        }
        #controls .slider-group {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #fff;
            font-size: 14px;
        }
        #controls label {
            font-weight: bold;
        }
        #controls input[type="range"] {
            cursor: pointer;
        }
    </style>
</head>
<body>

    <!-- Overlay to enable audio context -->
    <div id="audioOverlay">
        <div>
            <h1>Advance Firework</h1>
            <p>Click to start</p>
        </div>
    </div>
    
    <!-- Audio elements for realistic sounds -->
    <!-- These paths link to the files you uploaded -->
    <audio id="audioLaunch" src="1.mp3" preload="auto"></audio>
    <audio id="audioExplode" src="3.mp3" preload="auto"></audio>
    <audio id="audioCrackle" src="2.mp3" preload="auto"></audio>

    <canvas id="fireworksCanvas"></canvas>
    
    <!-- New controls for speed and frequency -->
    <div id="controls">
        <div class="slider-group">
            <label for="speedSlider">Speed:</label>
            <input type="range" id="speedSlider" min="0.5" max="2.0" value="1.0" step="0.1">
        </div>
        <div class="slider-group">
            <label for="frequencySlider">Frequency:</label>
            <input type="range" id="frequencySlider" min="0.5" max="5.0" value="1.5" step="0.1">
        </div>
    </div>

    <script>
        const canvas = document.getElementById('fireworksCanvas');
        const ctx = canvas.getContext('2d');
        const audioOverlay = document.getElementById('audioOverlay');
        const controls = document.getElementById('controls');
        const speedSlider = document.getElementById('speedSlider');
        const frequencySlider = document.getElementById('frequencySlider');

        let width = canvas.width = window.innerWidth;
        let height = canvas.height = window.innerHeight;

        let rockets = [];
        let particles = [];
        window.audioReady = false;

        // Firework type (now randomized since buttons are gone)
        const fireworkTypes = ['peony', 'glitter', 'crackle', 'trail', 'multi'];
        
        // Global speed and frequency settings
        let globalSpeedMultiplier = 1.0;
        let launchFrequency = 1.5; // This is the value from random(0, 100) < 1.5

        // Physics constants
        const gravity = 0.05;

        // --- Audio Setup ---

        /**
         * Plays an audio element by its ID, cloning it to allow for overlapping sounds.
         * @param {string} id The ID of the <audio> element to play.
         */
        function playSound(id) {
            if (!window.audioReady) return;
            try {
                const audio = document.getElementById(id);
                if (audio) {
                    const clone = audio.cloneNode(true);
                    
                    if (id === 'audioExplode' || id === 'audioCrackle') {
                        clone.playbackRate = random(0.85, 1.15); // Random pitch
                        clone.volume = random(0.7, 1.0);     // Random volume
                    } else {
                        clone.volume = 0.2; // Launch is a bit quieter (was 0.5)
                    }
                    
                    clone.play().catch(e => {
                        if (e.name !== 'AbortError') {
                            console.error("Audio play failed:", e);
                        }
                    });

                    // Stop the launch sound early to cut off the long echo
                    if (id === 'audioLaunch') {
                        setTimeout(() => {
                            if (!clone.paused) {
                                clone.pause();
                                clone.currentTime = 0; // Reset for next time
                            }
                        }, 500); // Stop after 500ms (0.5 seconds)
                    }
                }
            } catch (e) {
                console.error("Error playing sound:", e);
            }
        }

        function launchSound() {
            playSound('audioLaunch');
        }

        // Updated to play crackle sound if the type matches
        function explodeSound(type) {
            playSound('audioExplode');
            if (type === 'crackle') {
                // Play the crackle sound slightly delayed for realism
                setTimeout(() => {
                    playSound('audioCrackle');
                }, 100); 
            }
        }


        // --- Utility Functions ---
        function random(min, max) {
            return Math.random() * (max - min) + min;
        }

        function lerp(start, end, amt) {
            return (1 - amt) * start + amt * end;
        }

        // --- Rocket Class ---
        class Rocket {
            constructor(targetX, targetY, fireworkType) {
                this.x = width / 2;
                this.y = height;
                this.targetX = targetX;
                this.targetY = targetY;
                this.fireworkType = fireworkType;
                
                const angle = Math.atan2(this.targetY - this.y, this.targetX - this.x);
                const distance = Math.hypot(this.targetX - this.x, this.targetY - this.y);
                const framesToTarget = distance / (10 * globalSpeedMultiplier); 

                this.vx = (this.targetX - this.x) / framesToTarget;
                this.vy = (this.targetY - this.y) / framesToTarget;
                
                this.color = 'hsl(50, 100%, 70%)';
                this.size = 2;
                
                if (window.audioReady) launchSound();
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.vy += gravity * 0.05; // Rockets are affected by gravity slightly

                // Emit sputtering trail particles
                if (random(0, 100) < 50) { 
                    const trailColor = `hsl(40, 100%, ${random(60, 90)}%)`;
                    particles.push(new Particle(this.x, this.y, trailColor, 'rocket_trail'));
                }

                if (this.y <= this.targetY) {
                    // Explode
                    createExplosion(this.x, this.y, this.fireworkType);
                    return true; // Mark for deletion
                }
                return false;
            }

            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.fill();
            }
        }

        // --- Particle Class ---
        class Particle {
            constructor(x, y, color, type) {
                this.x = x;
                this.y = y;
                this.color = color;
                this.type = type; // 'normal', 'glitter', 'crackle', 'trail', 'rocket_trail', 'sub_rocket'

                const angle = random(0, Math.PI * 2);
                let speed;

                if (this.type === 'crackle') {
                    speed = random(2, 6) * globalSpeedMultiplier;
                } else if (this.type === 'rocket_trail') {
                    speed = random(0.5, 1.5) * globalSpeedMultiplier;
                } else {
                    speed = random(1, 8) * globalSpeedMultiplier;
                }

                this.vx = Math.cos(angle) * speed;
                this.vy = Math.sin(angle) * speed;

                if (this.type === 'rocket_trail') {
                    this.vx = random(-1, 1);
                    this.vy = random(0.5, 1.5); // Biased downwards
                }
                
                this.size = random(1, 3);
                this.friction = 0.98;
                this.opacity = 1;
                this.fade = random(0.01, 0.025);

                if (this.type === 'crackle') {
                    this.fade = random(0.05, 0.08);
                    this.size = random(2, 4);
                }
                
                if (this.type === 'trail') { // Willow
                    this.trail = [];
                    this.fade = random(0.008, 0.015); // Lasts much longer
                }

                if (this.type === 'rocket_trail') {
                    this.fade = random(0.08, 0.15); // Fades very fast
                    this.size = random(0.5, 1.5);
                    this.friction = 0.96;
                }

                if (this.type === 'sub_rocket') {
                    this.lifespan = random(30, 50); // Frames to live before bursting
                    this.size = 2.5;
                    this.fade = 0; // Doesn't fade, just explodes
                    this.friction = 0.99;
                }
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.vx *= this.friction;
                this.vy *= this.friction;

                // Apply gravity
                if (this.type === 'trail') {
                    this.vy += gravity * 1.5; // Extra gravity for "willow"
                } else if (this.type !== 'rocket_trail') {
                     this.vy += gravity;
                }
                
                this.opacity -= this.fade;

                // Add glitter effect
                if (this.type === 'glitter') {
                    if (random(0, 100) < 30) {
                        this.opacity = random(0, 1); // Flash
                    }
                }

                // Add trail effect for "willow"
                if (this.type === 'trail') {
                    this.trail.push({ x: this.x, y: this.y, opacity: this.opacity * 0.5 });
                    if (this.trail.length > 7) {
                        this.trail.shift();
                    }
                }

                // Handle sub-rocket explosion
                if (this.type === 'sub_rocket') {
                    this.lifespan--;
                    if (this.lifespan <= 0) {
                        // Create a small 'peony' burst
                        createExplosion(this.x, this.y, 'peony', 50); // 50 particles
                        this.opacity = 0; // Mark for deletion
                    }
                }
                
                // Handle crackle effect
                if (this.type === 'crackle' && this.opacity <= 0.5 && random(0, 100) < 10) {
                     // Create a tiny white burst
                    for (let i = 0; i < 3; i++) {
                        particles.push(new Particle(this.x, this.y, 'hsl(0, 0%, 100%)', 'crackle_pop'));
                    }
                }
                
                // 'crackle_pop' is a special type for the small crackle bursts
                if (this.type === 'crackle_pop') {
                    this.fade = random(0.1, 0.2); // Fades very fast
                    this.size = random(0.5, 1.5);
                }

                return this.opacity <= 0; // Return true if particle is dead
            }

            draw() {
                 ctx.globalAlpha = this.opacity;
                
                // Draw willow trail
                if (this.type === 'trail' && this.trail.length > 0) {
                    ctx.beginPath();
                    ctx.moveTo(this.trail[0].x, this.trail[0].y);
                    for (let i = 1; i < this.trail.length; i++) {
                        ctx.lineTo(this.trail[i].x, this.trail[i].y);
                    }
                    ctx.strokeStyle = this.color;
                    ctx.lineWidth = 1;
                    ctx.stroke();
                }

                // Draw main particle
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.fill();
                
                ctx.globalAlpha = 1.0; // Reset global alpha
            }
        }

        // --- Main Functions ---

        // Create a burst of particles based on type
        function createExplosion(x, y, type, particleCountOverride) {
            // Play sound, pass type for crackle
            if (window.audioReady && !particleCountOverride) {
                explodeSound(type);
            }
            
            const particleCount = particleCountOverride || (100 + Math.floor(random(0, 80)));
            const hue1 = random(0, 360);
            const hue2 = (hue1 + random(120, 240)) % 360; // Complementary or analogous

            // Specific logic for multi-burst
            if (type === 'multi') {
                const subRocketCount = Math.floor(random(3, 6));
                for (let i = 0; i < subRocketCount; i++) {
                    const subColor = `hsl(${random(0, 360)}, 100%, 70%)`;
                    particles.push(new Particle(x, y, subColor, 'sub_rocket'));
                }
                // Now, create a small 'peony' burst *as well* for the initial pop
                createExplosion(x, y, 'peony', 40); // 40 particle initial burst
                return; // Exit
            }


            for (let i = 0; i < particleCount; i++) {
                const useHue2 = random(0, 1) > 0.5;
                const hue = useHue2 ? hue2 : hue1;
                const color = `hsl(${hue}, 100%, ${random(50, 80)}%)`;
                
                let pType = 'normal';
                switch (type) {
                    case 'peony':
                        pType = 'normal';
                        break;
                    case 'trail':
                        pType = 'trail';
                        break;
                    default:
                        pType = 'normal';
                }
                particles.push(new Particle(x, y, color, pType));
            }
        }

        // --- Animation Loop ---
        function animate() {
            // Fading trail effect
            ctx.fillStyle = 'rgba(0, 0, 0, 0.15)';
            ctx.fillRect(0, 0, width, height);
            
            // --- Update and draw rockets ---
            for (let i = rockets.length - 1; i >= 0; i--) {
                if (rockets[i].update()) {
                    rockets.splice(i, 1);
                } else {
                    rockets[i].draw();
                }
            }

            // --- Update and draw particles ---
            for (let i = particles.length - 1; i >= 0; i--) {
                if (particles[i].update()) {
                    particles.splice(i, 1);
                } else {
                    particles[i].draw();
                }
            }

            // --- Auto-launch rockets ---
            if (random(0, 100) < launchFrequency) {
                // Pick a random type now that buttons are gone
                let launchType = fireworkTypes[Math.floor(random(0, fireworkTypes.length))];
                
                rockets.push(new Rocket(random(width * 0.2, width * 0.8), random(height * 0.1, height * 0.4), launchType));
            }

            requestAnimationFrame(animate);
        }

        function launchRocket(x, y, type) {
            rockets.push(new Rocket(x, y, type));
        }

        // --- Event Listeners ---

        // Resize
        window.addEventListener('resize', () => {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        });

        // Start audio and hide overlay
        audioOverlay.addEventListener('click', () => {
            window.audioReady = true;
            audioOverlay.style.display = 'none';
            animate();
        }, { once: true });

        // Handle slider inputs
        speedSlider.addEventListener('input', (e) => {
            globalSpeedMultiplier = parseFloat(e.target.value);
        });

        frequencySlider.addEventListener('input', (e) => {
            launchFrequency = parseFloat(e.target.value);
        });

        // Launch rocket on click
        canvas.addEventListener('click', (e) => {
            if (!window.audioReady) return;
            // Pick a random type
            let launchType = fireworkTypes[Math.floor(random(0, fireworkTypes.length))];
            launchRocket(e.clientX, e.clientY, launchType);
        });

        // Launch rocket on touch
        canvas.addEventListener('touchstart', (e) => {
            if (!window.audioReady) return;
            e.preventDefault(); 
            if (e.touches.length > 0) {
                const touch = e.touches[0];
                // Pick a random type
                let launchType = fireworkTypes[Math.floor(random(0, fireworkTypes.length))];
                launchRocket(touch.clientX, touch.clientY, launchType);
            }
        });
        
    </script>
</body>
</html>

