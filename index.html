<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Fireworks Generator</title>
    <!-- Import Tone.js for audio synthesis -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        /* Basic reset and full-screen setup */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            /* Dark background for the fireworks */
            background-color: #000;
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        /* Canvas should fill the entire screen */
        #fireworksCanvas {
            display: block;
            width: 100%;
            height: 100%;
            background-color: #000;
            cursor: pointer;
        }

        /* Simple instructions */
        #instructions {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255, 255, 255, 0.5);
            font-size: 1rem;
            pointer-events: none; /* Allows clicks to go through to the canvas */
            animation: fadeOut 5s forwards; /* Fade out after 5 seconds */
            animation-delay: 2s;
        }

        @keyframes fadeOut {
            from { opacity: 0.5; }
            to { opacity: 0; }
        }

        /* Overlay to start audio context */
        #audioOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            text-align: center;
            cursor: pointer;
            z-index: 10;
        }
    </style>
</head>
<body>
    <div id="audioOverlay">
        <div>
            Click to Start
            <br>
            <small>(Audio Required)</small>
        </div>
    </div>
    <canvas id="fireworksCanvas"></canvas>
    <div id="instructions">Click or tap to launch a firework</div>

    <script>
        // Get canvas and context
        const canvas = document.getElementById('fireworksCanvas');
        const ctx = canvas.getContext('2d');
        const audioOverlay = document.getElementById('audioOverlay');

        // Set canvas dimensions
        let cw = window.innerWidth;
        let ch = window.innerHeight;
        canvas.width = cw;
        canvas.height = ch;

        // Arrays to store rockets and explosion particles
        let rockets = [];
        let particles = [];

        // Physics constants
        const gravity = 0.05;

        // Audio variables
        let launchSynth, explodeSynth, boomSynth;
        window.audioReady = false;

        // --- Audio Setup ---
        function setupAudio() {
            // Rocket launch whistle
            launchSynth = new Tone.NoiseSynth({
                noise: { type: 'pink' },
                envelope: {
                    attack: 0.01,
                    decay: 0.1,
                    sustain: 0,
                }
            }).toDestination();
            
            // Create the filter and attach it to the launchSynth object
            launchSynth.filter = new Tone.Filter(800, "lowpass").toDestination();
            launchSynth.connect(launchSynth.filter);
            
            // Explosion crackle
            explodeSynth = new Tone.NoiseSynth({
                noise: { type: 'white' },
                envelope: {
                    attack: 0.005,
                    decay: 0.05,
                    sustain: 0
                }
            }).toDestination();

            // Explosion boom
            boomSynth = new Tone.MembraneSynth({
                pitchDecay: 0.05,
                octaves: 3,
                oscillator: { type: 'sine' },
                envelope: {
                    attack: 0.001,
                    decay: 0.5,
                    sustain: 0
                }
            }).toDestination();
            boomSynth.volume.value = -6; // Make it a bit quieter
        }

        function launchSound() {
            // Play a rising pitch
            launchSynth.envelope.attack = 0.01;
            launchSynth.envelope.decay = 0.3;
            launchSynth.triggerAttackRelease("0.3");
            
            // Sweep the filter frequency
            launchSynth.filter.frequency.setValueAtTime(400, Tone.now());
            launchSynth.filter.frequency.linearRampToValueAtTime(1200, Tone.now() + 0.3);
        }

        function explodeSound() {
            // Trigger the boom
            boomSynth.triggerAttackRelease("C1", "0.5");
            
            // Trigger multiple crackle sounds
            const now = Tone.now();
            explodeSynth.triggerAttackRelease("0.05", now);
            explodeSynth.triggerAttackRelease("0.05", now + 0.02);
            explodeSynth.triggerAttackRelease("0.05", now + 0.04);
        }


        // --- Utility Functions ---

        // Get a random number in a range
        function random(min, max) {
            return Math.random() * (max - min) + min;
        }

        // --- Rocket Class ---
        // This is the particle that flies up before exploding
        class Rocket {
            constructor(targetX, targetY) {
                this.x = cw / 2;
                this.y = ch;
                
                this.targetX = targetX;
                this.targetY = targetY;

                const framesToTarget = 80 + random(0, 40);
                this.vx = (this.targetX - this.x) / framesToTarget;
                this.vy = (this.targetY - this.y) / framesToTarget;
                
                this.color = 'hsl(50, 100%, 70%)';
                this.size = 2;
                this.trail = [];
                
                // Play launch sound
                if (window.audioReady) launchSound();
            }

            update() {
                this.x += this.vx;
                this.y += this.vy;
                this.vy += gravity * 0.05; 

                this.trail.push({ x: this.x, y: this.y });
                if (this.trail.length > 5) {
                    this.trail.shift();
                }

                if (this.y <= this.targetY) {
                    createExplosion(this.x, this.y);
                    return true;
                }
                return false;
            }

            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.fill();

                ctx.save();
                ctx.globalAlpha = 0.5;
                this.trail.forEach((pos, index) => {
                    ctx.beginPath();
                    ctx.arc(pos.x, pos.y, this.size * (index / this.trail.length), 0, Math.PI * 2);
                    ctx.fillStyle = this.color;
                    ctx.fill();
                });
                ctx.restore();
            }
        }

        // --- Particle Class ---
        // This is a single spark from the explosion
        class Particle {
            constructor(x, y, color, type) {
                this.x = x;
                this.y = y;
                this.color = color;
                this.type = type; // 'normal', 'glitter', 'crackle', 'trail'

                const angle = random(0, Math.PI * 2);
                let speed;

                if (this.type === 'crackle') {
                    speed = random(2, 6);
                } else {
                    speed = random(1, 8);
                }

                this.vx = Math.cos(angle) * speed;
                this.vy = Math.sin(angle) * speed;
                
                this.size = random(1, 3);
                this.friction = 0.98;
                this.opacity = 1;
                this.fade = random(0.01, 0.025);

                if (this.type === 'crackle') {
                    this.fade = random(0.05, 0.08); // Crackles fade fast
                    this.size = random(2, 4);
                }
                
                if (this.type === 'trail') {
                    this.trail = [];
                }
            }

            update() {
                // Apply physics
                this.x += this.vx;
                this.y += this.vy;
                this.vx *= this.friction;
                this.vy *= this.friction;
                this.vy += gravity;
                
                this.opacity -= this.fade;

                if (this.type === 'glitter') {
                    // Randomly flash
                    if (random(0, 100) < 10) {
                        this.opacity = random(0.1, 1);
                    }
                }
                
                if (this.type === 'trail') {
                    this.trail.push({ x: this.x, y: this.y, opacity: this.opacity * 0.5 });
                    if (this.trail.length > 7) {
                        this.trail.shift();
                    }
                }

                // Handle crackle
                if (this.type === 'crackle' && this.opacity <= 0) {
                    // Spawn sub-particles
                    const crackleCount = random(3, 6);
                    for (let i = 0; i < crackleCount; i++) {
                        const crackleColor = `hsl(0, 0%, ${random(70, 100)}%)`;
                        const subParticle = new Particle(this.x, this.y, crackleColor, 'normal');
                        subParticle.fade = random(0.05, 0.1); // Fade very fast
                        subParticle.size = random(0.5, 1.5);
                        subParticle.vx = random(-3, 3);
                        subParticle.vy = random(-3, 3);
                        particles.push(subParticle);
                    }
                }

                // Return true if faded
                return this.opacity <= 0;
            }

            draw() {
                ctx.save();
                ctx.globalAlpha = this.opacity;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.fill();
                ctx.restore();
                
                // Draw the trail
                if (this.type === 'trail') {
                    ctx.save();
                    this.trail.forEach((pos, index) => {
                        ctx.globalAlpha = pos.opacity * (index / this.trail.length);
                        ctx.beginPath();
                        ctx.arc(pos.x, pos.y, this.size * 0.5 * (index / this.trail.length), 0, Math.PI * 2);
                        ctx.fillStyle = this.color;
                        ctx.fill();
                    });
                    ctx.restore();
                }
            }
        }

        // --- Main Functions ---

        // Create a burst of particles
        function createExplosion(x, y) {
            // Trigger sound
            if (window.audioReady) explodeSound();
            
            const particleCount = 100 + Math.floor(random(0, 80));
            const hue1 = random(0, 360); // Base color
            // 50% chance of a second color
            const hue2 = random(0, 1) > 0.5 ? random(0, 360) : hue1;

            for (let i = 0; i < particleCount; i++) {
                const baseHue = (i % 2 === 0) ? hue1 : hue2;
                const particleColor = `hsl(${baseHue + random(-10, 10)}, 100%, ${random(50, 80)}%)`;
                
                // Assign a random type
                let pType = 'normal';
                const typeRand = random(0, 1);
                if (typeRand > 0.85) pType = 'crackle';      // 15% chance
                else if (typeRand > 0.7) pType = 'glitter'; // 15% chance
                else if (typeRand > 0.3) pType = 'trail';   // 40% chance
                // else 30% chance of 'normal'
                
                particles.push(new Particle(x, y, particleColor, pType));
            }
        }

        // Launch a rocket to a specific target
        function launchRocket(targetX, targetY) {
            rockets.push(new Rocket(targetX, targetY));
        }

        // --- Animation Loop ---
        function animate() {
            requestAnimationFrame(animate);

            // Fading effect
            ctx.fillStyle = 'rgba(0, 0, 0, 0.15)';
            ctx.fillRect(0, 0, cw, ch);

            // --- Update and Draw Rockets ---
            for (let i = rockets.length - 1; i >= 0; i--) {
                rockets[i].draw();
                if (rockets[i].update()) {
                    rockets.splice(i, 1);
                }
            }

            // --- Update and Draw Particles ---
            for (let i = particles.length - 1; i >= 0; i--) {
                particles[i].draw();
                if (particles[i].update()) {
                    particles.splice(i, 1);
                }
            }
            
            // --- Auto-launch rockets ---
            if (random(0, 100) < 1.5) {
                launchRocket(
                    random(cw * 0.2, cw * 0.8),
                    random(ch * 0.1, ch * 0.5)
                );
            }
        }

        // --- Event Listeners ---

        // Start audio and hide overlay
        audioOverlay.addEventListener('click', async () => {
            await Tone.start();
            setupAudio();
            window.audioReady = true;
            audioOverlay.style.display = 'none';
            // Start the animation loop *after* user interaction
            animate();
        }, { once: true });

        // Resize the canvas
        window.addEventListener('resize', () => {
            cw = window.innerWidth;
            ch = window.innerHeight;
            canvas.width = cw;
            canvas.height = ch;
        });

        // Launch rocket on click
        canvas.addEventListener('click', (e) => {
            if (!window.audioReady) return; // Don't launch if audio isn't ready
            launchRocket(e.clientX, e.clientY);
        });

        // Launch rocket on touch
        canvas.addEventListener('touchstart', (e) => {
            if (!window.audioReady) return;
            e.preventDefault(); 
            if (e.touches.length > 0) {
                launchRocket(e.touches[0].clientX, e.touches[0].clientY);
            }
        });
        
        // Note: animate() is now called *after* the audio overlay is clicked.

    </script>
</body>
</html>

